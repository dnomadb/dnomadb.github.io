var SphericalMercator=function(){var cache={},EPSLN=1e-10,D2R=Math.PI/180,R2D=180/Math.PI,A=6378137,MAXEXTENT=20037508.342789244;function SphericalMercator(options){options=options||{};this.size=options.size||256;if(!cache[this.size]){var size=this.size;var c=cache[this.size]={};c.Bc=[];c.Cc=[];c.zc=[];c.Ac=[];for(var d=0;d<30;d++){c.Bc.push(size/360);c.Cc.push(size/(2*Math.PI));c.zc.push(size/2);c.Ac.push(size);size*=2}}this.Bc=cache[this.size].Bc;this.Cc=cache[this.size].Cc;this.zc=cache[this.size].zc;this.Ac=cache[this.size].Ac}SphericalMercator.prototype.px=function(ll,zoom){var d=this.zc[zoom];var f=Math.min(Math.max(Math.sin(D2R*ll[1]),-.9999),.9999);var x=Math.round(d+ll[0]*this.Bc[zoom]);var y=Math.round(d+.5*Math.log((1+f)/(1-f))*-this.Cc[zoom]);x>this.Ac[zoom]&&(x=this.Ac[zoom]);y>this.Ac[zoom]&&(y=this.Ac[zoom]);return[x,y]};SphericalMercator.prototype.ll=function(px,zoom){var g=(px[1]-this.zc[zoom])/-this.Cc[zoom];var lon=(px[0]-this.zc[zoom])/this.Bc[zoom];var lat=R2D*(2*Math.atan(Math.exp(g))-.5*Math.PI);return[lon,lat]};SphericalMercator.prototype.bbox=function(x,y,zoom,tms_style,srs){if(tms_style){y=Math.pow(2,zoom)-1-y}var ll=[x*this.size,(+y+1)*this.size];var ur=[(+x+1)*this.size,y*this.size];var bbox=this.ll(ll,zoom).concat(this.ll(ur,zoom));if(srs==="900913"){return this.convert(bbox,"900913")}else{return bbox}};SphericalMercator.prototype.xyz=function(bbox,zoom,tms_style,srs){if(srs==="900913"){bbox=this.convert(bbox,"WGS84")}var ll=[bbox[0],bbox[1]];var ur=[bbox[2],bbox[3]];var px_ll=this.px(ll,zoom);var px_ur=this.px(ur,zoom);var x=[Math.floor(px_ll[0]/this.size),Math.floor((px_ur[0]-1)/this.size)];var y=[Math.floor(px_ur[1]/this.size),Math.floor((px_ll[1]-1)/this.size)];var bounds={minX:Math.min.apply(Math,x)<0?0:Math.min.apply(Math,x),minY:Math.min.apply(Math,y)<0?0:Math.min.apply(Math,y),maxX:Math.max.apply(Math,x),maxY:Math.max.apply(Math,y)};if(tms_style){var tms={minY:Math.pow(2,zoom)-1-bounds.maxY,maxY:Math.pow(2,zoom)-1-bounds.minY};bounds.minY=tms.minY;bounds.maxY=tms.maxY}return bounds};SphericalMercator.prototype.convert=function(bbox,to){if(to==="900913"){return this.forward(bbox.slice(0,2)).concat(this.forward(bbox.slice(2,4)))}else{return this.inverse(bbox.slice(0,2)).concat(this.inverse(bbox.slice(2,4)))}};SphericalMercator.prototype.forward=function(ll){var xy=[A*ll[0]*D2R,A*Math.log(Math.tan(Math.PI*.25+.5*ll[1]*D2R))];xy[0]>MAXEXTENT&&(xy[0]=MAXEXTENT);xy[0]<-MAXEXTENT&&(xy[0]=-MAXEXTENT);xy[1]>MAXEXTENT&&(xy[1]=MAXEXTENT);xy[1]<-MAXEXTENT&&(xy[1]=-MAXEXTENT);return xy};SphericalMercator.prototype.inverse=function(xy){return[xy[0]*R2D/A,(Math.PI*.5-2*Math.atan(Math.exp(-xy[1]/A)))*R2D]};return SphericalMercator}();if(typeof module!=="undefined"&&typeof exports!=="undefined"){module.exports=exports=SphericalMercator}
